root@srv1064472:/var/www/supernxt.com# # Install git
apt install -y git

# Clean up and create proper structure
rm -rf /var/www/supernxt.com
mkdir -p /var/www/supernxt.com/{repo.git,app}

# Create bare git repository
cd /var/www/supernxt.com/repo.git
git init --bare

# Create auto-deployment hook
cat > hooks/post-receive << 'HOOK'
#!/bin/bash
APP_DIR="/var/www/supernxt.com/app"
echo "Deploying to $APP_DIR..."

# Checkout the code
git --work-tree=$APP_DIR --git-dir=/var/www/supernxt.com/repo.git checkout -f

cd $APP_DIR

# Install dependencies
echo "Installing dependencies..."
npm ci --omit=dev

# Build the application
echo "Building application..."
npm run build

# Restart PM2
echo "Restarting application..."
pm2 delete supernxt 2>/dev/null || true
pm2 start dist/index.js --name supernxt --cwd $APP_DIR
pm2 save

echo "✅ Deployment complete!"
HOOK

# Make hook executable
chmod +x hooks/post-receive

echo "✅ Git deployment setup complete!"
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
git is already the newest version (1:2.43.0-1ubuntu7.3).
git set to manually installed.
The following packages were automatically installed and are no longer required:
  linux-headers-6.8.0-71 linux-headers-6.8.0-71-generic linux-image-6.8.0-71-generic linux-modules-6.8.0-71-generic linux-tools-6.8.0-71 linux-tools-6.8.0-71-generic
Use 'apt autoremove' to remove them.
0 upgraded, 0 newly installed, 0 to remove and 1 not upgraded.
hint: Using 'master' as the name for the initial branch. This default branch name
hint: is subject to change. To configure the initial branch name to use in all
hint: of your new repositories, which will suppress this warning, call:
hint:
hint:   git config --global init.defaultBranch <name>
hint:
hint: Names commonly chosen instead of 'master' are 'main', 'trunk' and
hint: 'development'. The just-created branch can be renamed via this command:
hint:
hint:   git branch -m <name>
Initialized empty Git repository in /var/www/supernxt.com/repo.git/
✅ Git deployment setup complete!
root@srv1064472:/var/www/supernxt.com/repo.git#
